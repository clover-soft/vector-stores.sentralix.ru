# Изменения в API для фронтендера: Привязка файлов к индексам

## Обзор изменений

Обновлена логика привязки файлов к индексам. Теперь файлы автоматически загружаются в провайдер при привязке к индексу.

## Ключевые изменения

### 1. Автоматическая загрузка в провайдер

**Раньше:** Файл просто привязывался к индексу в локальной БД
**Теперь:** При привязке файла к индексу он автоматически загружается в провайдер и привязывается к vector store

### 2. Изменения в API ручках

#### `POST /api/v1/indexes/{index_id}/files/{file_id}`

- **Без изменений** входные параметры
- **Без изменений** базовая логика
- **Добавлено:** автоматическая загрузка файла в провайдер если у индекса есть `external_id`
- **Добавлено:** установка `external_id` файла в таблице `rag_index_files`

### 3. Новые поля в ответах

В ответах API связанных с файлами индексов теперь может присутствовать поле `external_id`:

```json
{
  "include_order": 1,
  "file": {
    "id": "file-uuid",
    "file_name": "document.pdf",
    "chunking_strategy": {"type": "recursive", "chunk_size": 1000}
  },
  "external_id": "provider-file-uuid"  // НОВОЕ
}
```

### 4. Обработка ошибок

- Если файл не удалось загрузить в провайдера, связка все равно создается
- `external_id` остается `null` - это позволяет повторить загрузку позже через синхронизацию
- API возвращает успешный статус (200) даже если загрузка в провайдер не удалась

### 5. Стратегия чанков

- `chunking_strategy` продолжает храниться в `rag_files` (глобально для файла)
- При загрузке в провайдер используется стратегия из `rag_files`
- Независимо от индекса, один и тот же файл всегда использует одну стратегию чанков

## Что нужно изменить на фронтенде

### 1. Отображение статуса файла

Можно добавить индикатор загрузки файла в провайдер:
- Если `external_id` есть → файл загружен в провайдер ✅
- Если `external_id` null → файл привязан, но не загружен в провайдер ⏳

### 2. Обработка ошибок (опционально)

Можно добавить уведомления если файл не удалось загрузить в провайдер, но это не обязательно так как основная функциональность работает.

### 3. Синхронизация

Для файлов с `external_id = null` можно добавить кнопку "Повторить загрузку" которая будет вызывать синхронизацию индекса.

## Обратная совместимость

✅ Все существующие API ручки работают без изменений
✅ Старые данные продолжают работать корректно
✅ Не требуется обязательных изменений в текущем коде фронтенда

## Пример использования

```javascript
// Привязка файла к индексу (без изменений)
await fetch(`/api/v1/indexes/${indexId}/files/${fileId}`, {
  method: 'POST',
  headers: { 'X-Domain-Id': domainId }
});

// Проверка статуса файла в индексе
const response = await fetch(`/api/v1/indexes/${indexId}/files`, {
  headers: { 'X-Domain-Id': domainId }
});

const files = response.data.items;
files.forEach(file => {
  if (file.external_id) {
    console.log('Файл загружен в провайдер:', file.external_id);
  } else {
    console.log('Файл ожидает загрузки в провайдер');
  }
});
```

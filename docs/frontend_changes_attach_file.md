# Изменения в API для фронтендера: Привязка файлов к индексам

## Обзор изменений

Обновлена логика привязки файлов к индексам. Теперь файлы автоматически загружаются в провайдер при привязке к индексу, а стратегия чанков передается в теле запроса.

## Ключевые изменения

### 1. Автоматическая загрузка в провайдер

**Раньше:** Файл просто привязывался к индексу в локальной БД
**Теперь:** При привязке файла к индексу он автоматически загружается в провайдер и привязывается к vector store

### 2. Изменения в API ручках

#### `POST /api/v1/indexes/{index_id}/files/{file_id}`

**Новые входные параметры (в теле запроса):**
```json
{
  "chunking_strategy": {
    "type": "recursive",
    "chunk_size": 1000,
    "chunk_overlap": 200
  }
}
```

**Изменения:**
- Добавлено обязательное тело запроса с `chunking_strategy`
- `chunking_strategy` теперь устанавливается в контексте конкретного индекса
- Автоматическая загрузка файла в провайдер если у индекса есть `external_id`
- Установка `external_id` файла в таблице `rag_index_files`

### 3. Новые поля в ответах

В ответах API связанных с файлами индексов теперь присутствуют новые поля:

```json
{
  "include_order": 1,
  "file": {
    "id": "file-uuid",
    "file_name": "document.pdf"
  },
  "external_id": "provider-file-uuid",  // НОВОЕ
  "chunking_strategy": {               // НОВОЕ
    "type": "recursive",
    "chunk_size": 1000,
    "chunk_overlap": 200
  }
}
```

### 4. Обработка ошибок

- Если файл не удалось загрузить в провайдера, связка все равно создается
- `external_id` остается `null` - это позволяет повторить загрузку позже через синхронизацию
- API возвращает успешный статус (200) даже если загрузка в провайдер не удалась

### 5. Стратегия чанков

- `chunking_strategy` теперь хранится в `rag_index_files` (в контексте индекса)
- Один и тот же файл может иметь разные стратегии чанков в разных индексах
- При синхронизации используется стратегия из `rag_index_files`

## Что нужно изменить на фронтенде

### 1. Обязательное тело запроса

**Раньше:**
```javascript
await fetch(`/api/v1/indexes/${indexId}/files/${fileId}`, {
  method: 'POST',
  headers: { 'X-Domain-Id': domainId }
});
```

**Теперь:**
```javascript
await fetch(`/api/v1/indexes/${indexId}/files/${fileId}`, {
  method: 'POST',
  headers: { 
    'X-Domain-Id': domainId,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    chunking_strategy: {
      type: 'recursive',
      chunk_size: 1000,
      chunk_overlap: 200
    }
  })
});
```

### 2. Отображение статуса файла

Можно добавить индикатор загрузки файла в провайдер:
- Если `external_id` есть → файл загружен в провайдер ✅
- Если `external_id` null → файл привязан, но не загружен в провайдер ⏳

### 3. Отображение стратегии чанков

В списке файлов индекса можно показать используемую стратегию чанков для каждого файла.

### 4. Обработка ошибок (опционально)

Можно добавить уведомления если файл не удалось загрузить в провайдер, но это не обязательно так как основная функциональность работает.

### 5. Синхронизация

Для файлов с `external_id = null` можно добавить кнопку "Повторить загрузку" которая будет вызывать синхронизацию индекса.

## Обратная совместимость

❌ **Требуются изменения** - API ручка теперь требует тело запроса
✅ Старые данные продолжают работать корректно
✅ Новые поля в ответах опциональны

## Пример использования

```javascript
// Привязка файла к индексу с указанием стратегии чанков
const chunkingStrategy = {
  type: 'recursive',
  chunk_size: 1000,
  chunk_overlap: 200
};

await fetch(`/api/v1/indexes/${indexId}/files/${fileId}`, {
  method: 'POST',
  headers: { 
    'X-Domain-Id': domainId,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    chunking_strategy: chunkingStrategy
  })
});

// Проверка статуса файла в индексе
const response = await fetch(`/api/v1/indexes/${indexId}/files`, {
  headers: { 'X-Domain-Id': domainId }
});

const files = response.data.items;
files.forEach(file => {
  console.log('Файл:', file.file.file_name);
  console.log('Стратегия чанков:', file.chunking_strategy);
  
  if (file.external_id) {
    console.log('Файл загружен в провайдер:', file.external_id);
  } else {
    console.log('Файл ожидает загрузки в провайдер');
  }
});
```

## Важные замечания

1. **Обязательное тело запроса** - теперь нужно всегда передавать `chunking_strategy`
2. **Контекстная стратегия** - один файл может иметь разные стратегии в разных индексах
3. **Автоматическая загрузка** - файлы автоматически загружаются в провайдер при привязке
